<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoVisualization Portfolio</title>

    <!-- NEW: per-file autosave namespace -->
    <meta name="portfolio-id" content="">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        :root {
            --sidebar-width: 280px;
            --primary: #2c3e50;
            --accent: #27ae60;
            --danger: #e74c3c;
            --bg-color: #f8f9fa;
            --text-light: #ecf0f1;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #555;
            margin: 0 auto 10px;
            border: 3px solid var(--accent);
            overflow: hidden;
            position: relative;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: #bdc3c7;
            text-align: left;
            padding: 15px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.3s;
            border-radius: 8px;
            width: 100%;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 4px solid var(--accent);
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
            scroll-behavior: smooth;
            padding-bottom: 100px;
        }

        .page-section {
            display: none;
            padding: 40px;
        }

        .page-section.active {
            display: block;
            animation: fadeUp 0.5s ease;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- WEEK BLOCKS --- */
        .week-block {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: relative;
            border-left: 6px solid var(--accent);
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .category-section {
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 1.1rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 5px;
            margin-bottom: 15px;
            display: inline-block;
        }

        /* --- GALLERY GRID --- */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }

        .gallery-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .gallery-item:hover {
            transform: scale(1.02);
            z-index: 2;
        }

        .gallery-item:hover .img-container {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .img-container {
            height: 200px;
            width: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: #eee;
        }

        .img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.5s;
        }

        .item-data {
            display: none;
        }

        body.editing .item-data {
            display: flex;
            flex-direction: column;
            background: #fafafa;
            border: 1px dashed #ccc;
            padding: 10px;
            margin-top: 5px;
        }

        body.editing .gallery-item {
            cursor: default;
            transform: none;
        }

        .gallery-item[data-type="text"] {
            background: white;
            border: 1px solid #eee;
            height: 200px;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .gallery-item[data-type="text"] .item-data {
            display: block;
            height: 100%;
            overflow: hidden;
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        }

        .gallery-item[data-type="text"] .img-container {
            display: none;
        }

        /* --- EDITING UI --- */
        .delete-btn {
            display: none;
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.8rem;
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 20;
        }

        .editing .delete-btn {
            display: block;
        }

        .add-area-small {
            display: none;
            text-align: center;
            border: 2px dashed #ddd;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            color: #aaa;
            margin-top: 10px;
        }

        .add-area-small:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .add-area-big {
            display: none;
            margin: 40px 0;
            border: 3px dashed #ccc;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            color: #777;
            border-radius: 15px;
            font-size: 1.5rem;
        }

        .add-area-big:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .editing .add-area-small,
        .editing .add-area-big {
            display: block;
        }

        .file-upload-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .editing .file-upload-overlay {
            display: flex;
        }

        .editable-field {
            border: 1px dashed transparent;
            cursor: default;
        }

        .editing .editable-field {
            border: 1px dashed #f39c12;
            background: rgba(255, 255, 100, 0.1);
            cursor: text;
        }

        /* --- MODALS --- */
        #editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            justify-content: center;
            align-items: center;
        }

        #editor-modal.active {
            display: flex;
        }

        .editor-box {
            background: white;
            width: 800px;
            max-width: 90%;
            height: 80vh;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .editor-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        #quill-container {
            flex: 1;
            overflow-y: auto;
        }

        .editor-footer {
            padding: 15px;
            border-top: 1px solid #ddd;
            text-align: right;
            background: #f8f9fa;
        }

        .editor-btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
            margin-right: 10px;
        }

        .btn-ok {
            background: var(--accent);
            color: white;
        }

        /* --- EXPORT MODAL --- */
        #export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            z-index: 6000;
            flex-direction: column;
        }

        #export-modal.active {
            display: flex;
        }

        .export-header {
            padding: 20px;
            background: #000;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .export-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #222;
            color: white;
            font-size: 0.9rem;
        }

        .export-grid {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .export-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            opacity: 0.6;
            transition: 0.2s;
        }

        .export-item:hover {
            opacity: 1;
        }

        .export-item.selected {
            border-color: var(--accent);
            opacity: 1;
            transform: scale(0.95);
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.5);
        }

        .export-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .export-item .check-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .export-item.selected .check-icon {
            display: flex;
        }

        /* --- VIEW MODAL --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-card {
            background: white;
            width: 90%;
            height: 90%;
            display: flex;
            border-radius: 15px;
            overflow: hidden;
        }

        .modal-viz {
            flex: 2;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-viz img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .modal-text {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            border-left: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        .modal-card.text-only-mode .modal-viz {
            display: none;
        }

        .modal-card.text-only-mode .modal-text {
            flex: 1;
            padding: 60px;
            max-width: 800px;
            margin: 0 auto;
            border: none;
        }

        /* --- CONTROLS & TOAST --- */
        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button.ctrl-btn {
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-edit {
            background: var(--primary);
            color: white;
        }

        .btn-save {
            background: var(--accent);
            color: white;
            display: block;
        }

        .btn-export {
            background: #8e44ad;
            color: white;
        }

        .btn-reset {
            background: #e67e22;
            color: white;
            font-size: 0.8rem;
            padding: 12px 15px !important;
        }

        #autosave-toast {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-left: 5px solid #2ecc71;
            max-width: 300px;
        }

        #autosave-toast.visible {
            opacity: 1;
        }

        .toast-title {
            font-weight: bold;
            color: #2ecc71;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toast-msg {
            font-size: 0.8rem;
            opacity: 0.9;
            color: #ddd;
        }
    </style>
</head>

<body>

    <div id="autosave-toast">
        <div class="toast-title"><span>üíæ</span> Autosaved (Browser)</div>
        <div class="toast-msg">Don't forget to click "Save & Download" to create a permanent file!</div>
    </div>

    <div id="export-modal">
        <div class="export-header">
            <div>
                <h2 style="margin:0;">Gallery Studio</h2>
                <small style="color:#aaa;">Select images & layout style</small>
            </div>
            <div class="export-controls">
                <select id="export-layout" class="export-select">
                    <option value="dynamic" selected>Layout: Smart Mosaic (Flush Rows)</option>
                    <option value="uniform">Layout: Uniform Grid (Cropped)</option>
                </select>
                <button class="editor-btn btn-cancel" onclick="closeExportModal()">Close</button>
                <button class="editor-btn btn-ok" onclick="generateGallery()">‚¨áÔ∏è Download HTML</button>
            </div>
        </div>
        <div class="export-grid" id="export-grid-content"></div>
    </div>

    <div id="editor-modal">
        <div class="editor-box">
            <div class="editor-header">
                <h3>Editing Text</h3>
            </div>
            <div id="quill-container"></div>
            <div class="editor-footer">
                <button class="editor-btn btn-cancel" onclick="closeEditor(false)">Cancel</button>
                <button class="editor-btn btn-ok" onclick="closeEditor(true)">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="profile-area" id="profile-container">
            <div class="avatar">
                <img id="avatar-img" src="https://via.placeholder.com/150" alt="Avatar">
                <label class="file-upload-overlay" style="cursor: pointer;">
                    Change <input type="file" hidden onchange="updateSrc(this, 'avatar-img')">
                </label>
            </div>
            <div class="editable-field" style="margin-top:10px; font-weight:bold; font-size:1.2rem;"
                onclick="openEditor(this)">Student Name</div>
            <div class="editable-field" style="font-size:0.9rem; opacity:0.8;" onclick="openEditor(this)">Spring
                Semester 2026</div>
        </div>
        <button class="nav-btn active" onclick="switchTab('gallery')">üìÖ Weekly Timeline</button>
        <button class="nav-btn" onclick="switchTab('maps')">üåç Final Maps</button>
        <button class="nav-btn" onclick="switchTab('about')">üë§ About Me</button>
    </div>

    <div class="main-content">
        <div id="gallery" class="page-section active">
            <h1 class="editable-field" onclick="openEditor(this)">Course Gallery</h1>
            <div id="timeline-container"></div>
            <div class="add-area-big" onclick="addWeek()">
                <h2>+ Add New Week</h2>
            </div>
        </div>

        <div id="maps" class="page-section">
            <h1 class="editable-field" onclick="openEditor(this)">Interactive Maps</h1>
            <div id="maps-container"></div>
            <div class="add-area-big" onclick="addMapItem()">
                <h2>+ Add New Map Section</h2>
            </div>
        </div>

        <div id="about" class="page-section">
            <h1 class="editable-field" onclick="openEditor(this)">About Me</h1>
            <div id="about-container" class="editable-field desc-text" onclick="openEditor(this)">
                <p>Welcome! Click "Edit Mode" to customize.</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="vizModal" onclick="closeModal()">
        <div class="close-btn" onclick="closeModal()">√ó</div>
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="modal-viz"><img id="modal-img" src=""></div>
            <div class="modal-text">
                <h2 id="modal-title" style="margin-top:0;"></h2>
                <div id="modal-desc" class="desc-text"></div>
                <div id="modal-notebook-area"
                    style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                    <h4 style="margin:0 0 10px 0;">Notebook Source:</h4>
                    <div id="modal-notebook-content" class="notebook-wrapper visible"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="ctrl-btn btn-reset" onclick="resetLocalData()">‚ö†Ô∏è Reset</button>
        <button class="ctrl-btn btn-export" onclick="openExportModal()">‚ú® Export Gallery</button>
        <button class="ctrl-btn btn-edit" onclick="toggleEdit()">‚úèÔ∏è Edit Mode</button>
        <button class="ctrl-btn btn-save" onclick="saveFile()">üíæ Save & Download</button>
    </div>

    <script>
        let isEditing = false;
        let quill;
        let currentEditElement = null;

        // ===============================
        // FIXED: Stable autosave per file + unsaved changes warning
        // ===============================
        let dirtySinceManualSave = false;

        function generateId() {
            return (window.crypto && crypto.randomUUID)
                ? crypto.randomUUID()
                : ("id-" + Date.now() + "-" + Math.random().toString(16).slice(2));
        }

        // Stable mapping: same file (same URL) -> same portfolio-id
        function getUrlIdKey() {
            return `portfolio_id_by_url__${window.location.href}`;
        }

        function getOrCreateStableIdForThisFile() {
            const k = getUrlIdKey();
            let id = localStorage.getItem(k);
            if (!id) {
                id = generateId();
                localStorage.setItem(k, id);
            }
            return id;
        }

        function getPortfolioId() {
            let meta = document.querySelector('meta[name="portfolio-id"]');
            if (!meta) {
                meta = document.createElement('meta');
                meta.name = "portfolio-id";
                document.head.appendChild(meta);
            }

            const metaVal = (meta.content || "").trim();

            // If meta is empty, hydrate from stable per-file id
            if (!metaVal) {
                meta.content = getOrCreateStableIdForThisFile();
            } else {
                // If meta has an id, keep it as the canonical id for this file URL
                localStorage.setItem(getUrlIdKey(), metaVal);
            }

            return (meta.content || "").trim();
        }

        function getStorageKey() {
            return `portfolio_backup__${getPortfolioId()}`;
        }

        function markDirty() {
            dirtySinceManualSave = true;
        }

        window.onload = function () {
            quill = new Quill('#quill-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['link', 'clean']
                    ]
                }
            });

            const hasRestored = restoreLocalData();
            if (!hasRestored && document.getElementById('timeline-container').children.length === 0) {
                addWeek();
            }
            Prism.highlightAll();
            setInterval(saveLocalData, 30000);

            // warn on close/refresh if changes since last manual download
            window.addEventListener('beforeunload', (e) => {
                if (dirtySinceManualSave) {
                    e.preventDefault();
                    e.returnValue = "";
                }
            });
        };

        // --- AUTOSAVE LOGIC (PER-FILE KEY) ---
        function saveLocalData() {
            const data = {
                timeline: document.getElementById('timeline-container').innerHTML,
                maps: document.getElementById('maps-container').innerHTML,
                about: document.getElementById('about-container').innerHTML,
                profile: document.getElementById('profile-container').innerHTML
            };
            localStorage.setItem(getStorageKey(), JSON.stringify(data));

            const toast = document.getElementById('autosave-toast');
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 5000);
        }

        function restoreLocalData() {
            const stored = localStorage.getItem(getStorageKey());
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    document.getElementById('timeline-container').innerHTML = data.timeline || "";
                    document.getElementById('maps-container').innerHTML = data.maps || "";
                    document.getElementById('about-container').innerHTML = data.about || "";
                    document.getElementById('profile-container').innerHTML = data.profile || "";
                    return true;
                } catch (e) { console.error("Error restoring data", e); }
            }
            return false;
        }

        function resetLocalData() {
            if (confirm("‚ö†Ô∏è Are you sure you want to clear autosave data for THIS HTML file? This will revert the page to default on reload.")) {
                localStorage.removeItem(getStorageKey());
                location.reload();
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // --- EDITOR LOGIC ---
        function openEditor(element) {
            if (!isEditing) return;
            currentEditElement = element;
            quill.root.innerHTML = element.innerHTML;
            document.getElementById('editor-modal').classList.add('active');
        }

        function closeEditor(save) {
            if (save && currentEditElement) {
                currentEditElement.innerHTML = quill.root.innerHTML;
                markDirty();
                saveLocalData();
            }
            document.getElementById('editor-modal').classList.remove('active');
            currentEditElement = null;
        }

        // --- EXPORT GALLERY LOGIC (WITH SMART MOSAIC) ---
        function openExportModal() {
            const grid = document.getElementById('export-grid-content');
            grid.innerHTML = '';
            const images = document.querySelectorAll('.gallery-item[data-type="standard"]');

            images.forEach((item) => {
                const imgEl = item.querySelector('.viz-source');
                const title = item.querySelector('.item-title').innerText;
                const thumb = document.createElement('div');
                thumb.className = 'export-item';
                thumb.onclick = function () { this.classList.toggle('selected'); };

                thumb.innerHTML = `<img src="${imgEl.src}"><div class="check-icon">‚úì</div><div style="position:absolute; bottom:0; background:rgba(0,0,0,0.7); color:white; width:100%; font-size:0.8rem; padding:5px; box-sizing:border-box;">${title}</div>`;

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const imgObj = new Image();
                imgObj.crossOrigin = "Anonymous";
                imgObj.src = imgEl.src;

                thumb.dataset.title = title;
                thumb.dataset.desc = item.querySelector('.desc-text').innerHTML;
                thumb.dataset.originalSrc = imgEl.src;
                thumb.dataset.exportSrc = imgEl.src;
                thumb.dataset.ratio = 1.5;

                imgObj.onload = function () {
                    thumb.dataset.ratio = imgObj.width / imgObj.height;
                    canvas.width = imgObj.width;
                    canvas.height = imgObj.height;
                    ctx.drawImage(imgObj, 0, 0);
                    try { thumb.dataset.exportSrc = canvas.toDataURL('image/png'); } catch (e) { }
                }

                grid.appendChild(thumb);
            });
            document.getElementById('export-modal').classList.add('active');
        }

        function closeExportModal() { document.getElementById('export-modal').classList.remove('active'); }

        function generateGallery() {
            const selectedItems = document.querySelectorAll('.export-item.selected');
            if (selectedItems.length === 0) { alert("Please select at least one image."); return; }

            const layoutType = document.getElementById('export-layout').value;

            let galleryItemsHTML = '';
            const baseHeight = 400;

            selectedItems.forEach((item, index) => {
                const imgSrc = item.dataset.exportSrc || item.dataset.originalSrc;
                let styleStr = '';

                if (layoutType === 'dynamic') {
                    const ratio = parseFloat(item.dataset.ratio) || 1.5;
                    const growFactor = ratio * 100;
                    const flexBasis = Math.floor(baseHeight * ratio);
                    styleStr = `style="flex-grow: ${growFactor}; flex-basis: ${flexBasis}px;"`;
                }

                galleryItemsHTML += `
                <div class="card gallery-card" id="card-${index}" data-img="${imgSrc}" ${styleStr}>
                    <div class="card-inner">
                        <img src="${imgSrc}" alt="Gallery Image">
                        <div class="card-content">
                            <h3>${item.dataset.title}</h3>
                            <div class="desc">${item.dataset.desc}</div>
                        </div>
                    </div>
                </div>`;
            });

            let containerCSS = '';
            let cardCSS = '';

            if (layoutType === 'uniform') {
                containerCSS = `display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 40px;`;
                cardCSS = `height: 400px; width: 100%;`;
            } else {
                containerCSS = `display: flex; flex-wrap: wrap; gap: 20px;`;
                cardCSS = `height: 40vh; min-height: 400px; max-width: 100%; position: relative;`;
            }

            const newFileContent = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Immersive Gallery</title>
<style>
    :root { --dark: #111; --light: #eee; --accent: #27ae60; }
    body { background-color: var(--dark); color: var(--light); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 40px; overflow-x: hidden; perspective: 1000px; }
    .noise { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0.07; background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIxIi8+PC9zdmc+'); }
    h1 { text-align: center; font-weight: 300; letter-spacing: 5px; margin-bottom: 60px; text-transform: uppercase; font-size: 3rem; text-shadow: 0 0 20px rgba(255,255,255,0.3); position: relative; z-index: 20; }
    .gallery-container { ${containerCSS} max-width: 1600px; margin: 0 auto; position: relative; z-index: 20; }
    .gallery-container::after { content: ''; flex-grow: 999999999; min-width: 200px; height: 0; }
    .card { ${cardCSS} background: transparent; perspective: 1000px; cursor: pointer; border-radius: 8px; overflow: hidden; }
    .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); transform-style: preserve-3d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .card:hover .card-inner { transform: scale(0.98); box-shadow: 0 20px 40px rgba(0,0,0,0.8); }
    .card img { width: 100%; height: 100%; object-fit: cover; display: block; filter: brightness(0.9) contrast(1.1); transition: 0.5s; }
    .card:hover img { filter: brightness(1); transform: scale(1.02); }
    .card-content { position: absolute; bottom: 0; left: 0; width: 100%; padding: 25px; box-sizing: border-box; background: linear-gradient(to top, black 20%, transparent 100%); transform: translateZ(30px); opacity: 0; transition: 0.4s; pointer-events: none; }
    .card:hover .card-content { opacity: 1; transform: translateZ(50px) translateY(-10px); }
    h3 { margin: 0 0 5px 0; color: #fff; font-size: 1.4rem; letter-spacing: 1px; }
    .desc { font-size: 0.9rem; color: #ccc; max-height: 80px; overflow: hidden; }
    #lightbox { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 10000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
    #lightbox.active { display: flex; opacity: 1; }
    .lb-content { width: 90vw; height: 85vh; background: #1a1a1a; border-radius: 12px; display: flex; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 1px solid #333; position: relative; }
    .lb-image-container { flex: 2; background: #000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .lb-image-container img { max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    .lb-text-container { flex: 1; padding: 40px; overflow-y: auto; border-left: 1px solid #333; display: flex; flex-direction: column; }
    .lb-title { font-size: 2rem; margin-top: 0; color: var(--accent); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
    .lb-desc { font-size: 1.1rem; line-height: 1.6; color: #ddd; }
    .lb-desc p { margin-bottom: 1em; }
    .close-lb { position: absolute; top: 20px; right: 20px; color: white; font-size: 2.5rem; cursor: pointer; user-select: none; z-index: 100; line-height: 1; }
    .close-lb:hover { color: #e74c3c; transform: scale(1.1); transition: 0.2s; }
    @media (max-width: 900px) { .lb-content { flex-direction: column; height: 90vh; } .lb-image-container { flex: 1; } .lb-text-container { flex: 1; padding: 20px; } }
</style>
</head>
<body>
    <div class="noise"></div>
    <h1>Visuals & Reflections</h1>
    <div class="gallery-container">${galleryItemsHTML}</div>
    <div id="lightbox">
        <div class="lb-content">
            <div class="close-lb" id="close-btn">&times;</div>
            <div class="lb-image-container"><img id="lb-img" src=""></div>
            <div class="lb-text-container"><h2 id="lb-title" class="lb-title"></h2><div id="lb-desc" class="lb-desc"></div></div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cards = document.querySelectorAll('.gallery-card');
            const lightbox = document.getElementById('lightbox');
            const closeBtn = document.getElementById('close-btn');
            cards.forEach(card => {
                card.addEventListener('click', () => {
                    const imgSrc = card.getAttribute('data-img');
                    const title = card.querySelector('h3').innerText;
                    const desc = card.querySelector('.desc').innerHTML;
                    document.getElementById('lb-img').src = imgSrc;
                    document.getElementById('lb-title').innerText = title;
                    document.getElementById('lb-desc').innerHTML = desc;
                    lightbox.classList.add('active');
                });
            });
            closeBtn.addEventListener('click', () => lightbox.classList.remove('active'));
            lightbox.addEventListener('click', (e) => { if(e.target === lightbox) lightbox.classList.remove('active'); });
        });
    <\/script>
</body>
</html>`;

            const blob = new Blob([newFileContent], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "GeoViz_Showcase.html";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- EXISTING UTILS ---
        function createCategory(title, type) {
            return `<div class="category-section">
                <div class="category-title editable-field" onclick="openEditor(this)">${title}</div>
                <div class="gallery-grid"></div>
                <div class="add-area-small" onclick="addGalleryItem(this, '${type}')">+ Add Item</div>
            </div>`;
        }

        function addWeek() {
            const weekNum = document.querySelectorAll('.week-block').length + 1;
            const weekId = 'week-' + weekNum;
            const weekTemplate = `<div class="week-block" id="${weekId}">
                <div class="week-header">
                    <h2 class="editable-field" onclick="openEditor(this)">Week ${weekNum}</h2>
                    <button class="delete-btn" onclick="deleteElement(this, event)">üóëÔ∏è Delete Week</button>
                </div>
                ${createCategory("üíª Labs & Exercises", "standard")}
                ${createCategory("üìä Good vs Bad Viz", "standard")}
                ${createCategory("üìñ Reading Reflections", "text")}
                ${createCategory("üöÄ Project Progress", "standard")}
                ${createCategory("üí¨ Peer Review & Extras", "standard")}
            </div>`;
            document.getElementById('timeline-container').insertAdjacentHTML('beforeend', weekTemplate);

            const newWeek = document.getElementById('timeline-container').lastElementChild;
            newWeek.querySelectorAll('.add-area-small').forEach(btn => {
                const type = btn.getAttribute('onclick').includes("'text'") ? 'text' : 'standard';
                addGalleryItem(btn, type);
            });

            markDirty();
            saveLocalData();
        }

        function addGalleryItem(btnElement, type) {
            const targetGrid = btnElement.previousElementSibling;
            let imagePart = type === 'standard'
                ? `<div class="img-container">
                        <img class="viz-source" src="https://via.placeholder.com/600x400" alt="Viz">
                        <label class="file-upload-overlay">Change Img <input type="file" hidden onchange="updateCardImage(this)"></label>
                   </div>`
                : '';

            const template = `<div class="gallery-item" data-type="${type}" onclick="openModal(this)">
                <button class="delete-btn" onclick="deleteElement(this, event)">üóëÔ∏è</button>
                ${imagePart}
                <div class="item-data" onclick="event.stopPropagation()">
                    <h3 class="editable-field item-title" onclick="openEditor(this)">Title</h3>
                    <div class="editable-field desc-text" onclick="openEditor(this)"><p>${type === 'text' ? 'Reflections...' : 'Description...'}</p></div>
                    ${type === 'standard' ? `
                        <div class="code-controls">
                            <div class="switch-wrapper">
                                <label class="switch"><input type="checkbox"><span class="slider"></span></label>
                                <span>Show NB in Modal</span>
                            </div>
                            <div class="upload-area"><input type="file" accept=".ipynb,.py" onchange="handleNotebookUpload(this)"></div>
                        </div>
                    ` : ''}
                    <div class="notebook-wrapper"></div>
                </div>
            </div>`;

            targetGrid.insertAdjacentHTML('beforeend', template);
            Prism.highlightAll();

            markDirty();
            saveLocalData();
        }

        function addMapItem() {
            const template = `<div class="map-wrapper">
                <button class="delete-btn" onclick="deleteElement(this, event)">üóëÔ∏è Delete Section</button>
                <h2 class="editable-field" onclick="openEditor(this)">New Map Title</h2>
                <div class="html-container">
                    <iframe src="about:blank"></iframe>
                    <label class="file-upload-overlay">
                        <div><h3>Select HTML File</h3><input type="file" onchange="updateMapFrame(this)"></div>
                    </label>
                </div>
                <div class="editable-field desc-text" onclick="openEditor(this)">Description...</div>
            </div>`;
            document.getElementById('maps-container').insertAdjacentHTML('beforeend', template);

            markDirty();
            saveLocalData();
        }

        function handleNotebookUpload(input) {
            const file = input.files[0];
            const wrapper = input.closest('.item-data').querySelector('.notebook-wrapper');
            const reader = new FileReader();
            reader.onload = function (e) {
                let content = e.target.result;
                wrapper.innerHTML = "";

                if (file.name.endsWith('.ipynb')) {
                    try {
                        const json = JSON.parse(content);
                        let count = 1;
                        if (json.cells) {
                            json.cells.forEach(cell => {
                                if (cell.cell_type === "code") {
                                    let sourceCode = Array.isArray(cell.source) ? cell.source.join("") : cell.source;
                                    wrapper.innerHTML += `
                                        <div class="nb-cell" style="display:flex; margin-bottom:10px;">
                                            <div style="width:40px; text-align:right; padding-right:10px;">In [${count}]:</div>
                                            <div style="flex-grow:1; background:#f7f7f7; padding:5px;">
                                                <pre><code class="language-python">${escapeHtml(sourceCode)}</code></pre>
                                            </div>
                                        </div>`;
                                    count++;
                                }
                            });
                        }
                    } catch (err) {
                        alert("Invalid .ipynb");
                    }
                } else {
                    wrapper.innerHTML = `<pre><code class="language-python">${escapeHtml(content)}</code></pre>`;
                }

                Prism.highlightAllUnder(wrapper);
                markDirty();
                saveLocalData();
            };
            reader.readAsText(file);
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function deleteElement(btn, event) {
            event.stopPropagation();

            // Prefer the *closest* meaningful container:
            // 1) gallery item (smallest scope)
            // 2) map section
            // 3) week block (largest scope)
            const galleryItem = btn.closest('.gallery-item');
            const mapWrapper = btn.closest('.map-wrapper');
            const weekBlock = btn.closest('.week-block');

            const target = galleryItem || mapWrapper || weekBlock;

            if (!target) {
                console.warn("Delete target not found.");
                return;
            }

            // Friendly label for confirm
            let label = "this item";
            if (target === weekBlock) label = "this week";
            else if (target === mapWrapper) label = "this map section";

            if (confirm(`Delete ${label}?`)) {
                target.remove();
                markDirty();
                saveLocalData();
            }
        }

        function toggleEdit() {
            isEditing = !isEditing;
            document.body.classList.toggle('editing');
            const btn = document.querySelector('.btn-edit');
            if (isEditing) {
                btn.innerText = "Done Editing";
                btn.style.background = "#27ae60";
            } else {
                btn.innerText = "‚úèÔ∏è Edit Mode";
                btn.style.background = "#1a1a1a";
            }
        }

        function openModal(trigger) {
            if (isEditing) return;
            const card = trigger.closest('.gallery-item');
            const type = card.getAttribute('data-type');

            document.getElementById('modal-title').innerText = card.querySelector('.item-title').innerText;
            document.getElementById('modal-desc').innerHTML = card.querySelector('.desc-text').innerHTML;

            if (type === 'text') {
                document.querySelector('.modal-card').classList.add('text-only-mode');
                document.getElementById('modal-notebook-area').style.display = "none";
            } else {
                document.querySelector('.modal-card').classList.remove('text-only-mode');
                document.getElementById('modal-img').src = card.querySelector('.viz-source').src;

                const isNbVisible = card.querySelector('input[type="checkbox"]')?.checked;
                document.getElementById('modal-notebook-area').style.display = isNbVisible ? "block" : "none";
                if (isNbVisible) {
                    document.getElementById('modal-notebook-content').innerHTML =
                        card.querySelector('.notebook-wrapper').innerHTML;
                }
            }
            document.getElementById('vizModal').classList.add('open');
        }

        function closeModal() { document.getElementById('vizModal').classList.remove('open'); }

        function updateSrc(input, imgId) {
            if (input.files[0]) {
                document.getElementById(imgId).src = input.files[0].name;
                markDirty();
                saveLocalData();
            }
        }

        function updateCardImage(input) {
            if (input.files[0]) {
                input.closest('.img-container').querySelector('.viz-source').src = input.files[0].name;
                markDirty();
                saveLocalData();
            }
        }

        function updateMapFrame(input) {
            if (input.files[0]) {
                input.closest('.html-container').querySelector('iframe').src = input.files[0].name;
                markDirty();
                saveLocalData();
            }
        }

        // NEW: Save & Download that prevents autosave from "messing up" other copies
        function saveFile() {
            if (isEditing) toggleEdit();

            // Preserve checkbox state in exported HTML
            document.querySelectorAll('input[type="checkbox"]').forEach(box => {
                if (box.checked) box.setAttribute('checked', 'checked');
                else box.removeAttribute('checked');
            });

            // Ask filename
            const currentPathName = (window.location.pathname || "");
            const currentFileName = (currentPathName.split('/').pop() || "").trim(); // works for file:// and http(s)
            const fallbackDefault = "GeoViz_Portfolio.html";
            const defaultName = currentFileName || fallbackDefault;

            const filename = (prompt("Filename to download:", defaultName) || defaultName).trim() || defaultName;

            // Decide exportId:
            // If user saves with a DIFFERENT filename than the currently opened file,
            // we ALWAYS create a new portfolio-id so autosave does NOT carry over.
            const currentId = getPortfolioId();
            const isSaveAsNewFile = (filename !== defaultName);

            const exportId = isSaveAsNewFile ? generateId() : currentId;

            // Ensure meta exists
            let meta = document.querySelector('meta[name="portfolio-id"]');
            if (!meta) {
                meta = document.createElement('meta');
                meta.name = "portfolio-id";
                document.head.appendChild(meta);
            }

            // Temporarily set meta to exportId for the exported HTML only
            const originalMeta = meta.content;
            meta.content = exportId;

            const htmlContent = "<!DOCTYPE html>\n<html lang='en'>" + document.documentElement.innerHTML + "</html>";

            // Restore current page meta so THIS page keeps its own autosave continuity
            meta.content = (originalMeta && originalMeta.trim()) ? originalMeta : currentId;

            // Download
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // Mark manual save done (so close warning doesn't appear)
            dirtySinceManualSave = false;

            // IMPORTANT: do NOT seed localStorage for exportId.
            // The downloaded file already contains the current state in its HTML,
            // and seeding can make it look like it ‚Äúinherited‚Äù autosaves.
        }

    </script>
</body>

</html>